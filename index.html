<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 6. Title 規則 -->
    <title>常溫病人照護日誌｜Ambient Patient Care Log</title>
    
    <!-- 4. JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "常溫病人照護日誌",
      "alternateName": "Ambient Patient Care Log",
      "description": "專為家庭照護設計的紀錄工具，提供血壓、血糖、飲食與排便紀錄功能。",
      "applicationCategory": "HealthApplication",
      "operatingSystem": "Any",
      "author": {
        "@type": "Organization",
        "name": "常溫編集所 Ambient Edit Studio"
      }
    }
    </script>

    <!-- Google Fonts: Noto Serif TC & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Brand Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            paper: '#fdfbf7', // 背景紙色
                            ink: '#4a4a4a',   // 主要文字
                            sage: '#8da399',  // 品牌主色 (綠)
                            clay: '#d4a59a',  // 輔助色 (紅/橘)
                            sand: '#e6e2dd',  // 線條/邊框
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    boxShadow: {
                        soft: '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        card: '0 2px 10px rgba(0, 0, 0, 0.03)',
                    },
                    backgroundImage: {
                        'noise': "url(\"data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E\")"
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #fdfbf7; 
            color: #4a4a4a;
        }
        /* 標題專用字體 */
        h1, h2, h3, .brand-font {
            font-family: 'Noto Serif TC', serif;
        }
        
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; font-weight: 500; color: #4a4a4a; margin-bottom: 0.35rem; font-size: 0.9rem; letter-spacing: 0.02em; }
        .input-field { 
            width: 100%; 
            padding: 0.7rem; 
            border-radius: 0.5rem; 
            border: 1px solid #e6e2dd; 
            background-color: rgba(255, 255, 255, 0.8);
            outline: none; 
            transition: all 0.3s ease; 
            font-size: 0.95rem; 
            color: #4a4a4a;
        }
        .input-field:focus { 
            border-color: #8da399; 
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(141, 163, 153, 0.1); 
        }
        
        .btn-primary { 
            background-color: #8da399; 
            color: white; 
            padding: 0.85rem; 
            border-radius: 0.5rem; 
            width: 100%; 
            font-weight: 600; 
            letter-spacing: 0.05em;
            transition: all 0.3s; 
            box-shadow: 0 4px 6px -1px rgba(141, 163, 153, 0.3);
        }
        .btn-primary:hover { 
            background-color: #7a9187; 
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background-color: rgba(255,255,255,0.6); 
            border: 1px solid #e6e2dd; 
            color: #4a4a4a; 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            border-color: #8da399;
            color: #8da399;
        }

        .card { 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(8px);
            border: 1px solid #fff;
            border-radius: 1rem; 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.03); 
            padding: 0; 
            margin-bottom: 1.5rem; 
            overflow: hidden; 
        }
        .card-header { padding: 1rem 1.5rem; background-color: rgba(230, 226, 221, 0.2); border-bottom: 1px solid #e6e2dd; }
        .card-body { padding: 1.5rem; }
        
        .nav-item { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; color: #9ca3af; }
        .nav-item.active { background-color: rgba(141, 163, 153, 0.1); color: #8da399; }
        
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #8da399; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .spinner-white { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 4px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Badges adapted to brand colors */
        .badge-sugar { background-color: #fff7ed; color: #d4a59a; border: 1px solid #fed7aa; padding: 2px 10px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.02em; }
        .badge-bp { background-color: #f0f9ff; color: #6b7280; border: 1px solid #e0f2fe; padding: 2px 10px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.02em; }
        .badge-hr { background-color: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; padding: 2px 10px; border-radius: 99px; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.02em; }
        
        .badge-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 8px; letter-spacing: 0.03em; }
        
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 噪音紋理疊加 */
        .bg-noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="antialiased">
    <div class="bg-noise"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzuba69RCVJhp_hYzgQB9X7jLMThFkIotjbtzfpqSH_mmest0flzX8sdf-Q5h5JtvYg/exec";
        const STORAGE_KEY_HISTORY = 'patient_tracker_history_v1';

        const OPTIONS = {
            bowel: ['正常', '便秘', '腹瀉', '失禁', '其他'],
            appetite: ['正常', '佳', '差', '其他'],
            mood: ['平穩', '開心', '焦慮', '生氣', '憂鬱', '躁動', '其他']
        };

        const App = () => {
            const [view, setView] = useState('record'); 
            const [gasUrl, setGasUrl] = useState(localStorage.getItem('patient_tracker_url') || DEFAULT_API_URL);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            
            const [isEditing, setIsEditing] = useState(false);
            const [editingUuid, setEditingUuid] = useState(null);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTargetUuid, setDeleteTargetUuid] = useState(null);

            const initialFormState = {
                bpSystolic: '', bpDiastolic: '', bloodSugar: '', heartRate: '',
                medication: '', bowelStatus: '', bowelNotes: '',
                appetite: '', dietContent: '', mood: '', behaviorNotes: ''
            };
            const [formData, setFormData] = useState(initialFormState);

            useEffect(() => {
                if (!localStorage.getItem('patient_tracker_url')) {
                    localStorage.setItem('patient_tracker_url', DEFAULT_API_URL);
                    setGasUrl(DEFAULT_API_URL);
                }
                lucide.createIcons();
            }, [view, historyData, showDeleteModal]);

            const showMessage = (type, text) => {
                setMessage({ type, text });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleNavToRecord = () => {
                if (view !== 'record' || isEditing) {
                    setIsEditing(false);
                    setEditingUuid(null);
                    setFormData(initialFormState); 
                    setView('record');
                }
            };

            // 5. 統一設定本地存取 (核心邏輯)
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!gasUrl) {
                    showMessage('error', 'API URL 未設定');
                    setView('settings');
                    return;
                }

                setLoading(true);
                
                const action = isEditing ? 'update' : 'create';
                const currentUuid = isEditing ? editingUuid : crypto.randomUUID(); 
                
                const now = new Date();
                const todayStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

                const formatPayloadField = (status, content) => {
                    const statusPart = status ? `[${status}]` : '';
                    return `${statusPart} ${content || ''}`.trim();
                };

                const newDataItem = {
                    uuid: currentUuid,
                    date: todayStr,
                    time: timeStr,
                    bpSystolic: formData.bpSystolic,
                    bpDiastolic: formData.bpDiastolic,
                    bloodSugar: formData.bloodSugar,
                    heartRate: formData.heartRate,
                    medication: formData.medication,
                    bowel: formatPayloadField(formData.bowelStatus, formData.bowelNotes),
                    diet: formatPayloadField(formData.appetite, formData.dietContent),
                    behavior: formatPayloadField(formData.mood, formData.behaviorNotes)
                };

                let updatedHistory;
                if (isEditing) {
                    updatedHistory = historyData.map(item => item.uuid === currentUuid ? { ...item, ...newDataItem } : item);
                } else {
                    updatedHistory = [newDataItem, ...historyData];
                }
                
                setHistoryData(updatedHistory);
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(updatedHistory));
                
                showMessage('success', isEditing ? '修改成功！' : '紀錄已送出！');
                
                setFormData(initialFormState);
                setIsEditing(false);
                setEditingUuid(null);
                if (isEditing) {
                    setView('history');
                }

                try {
                    const payload = {
                        action: action,
                        uuid: currentUuid,
                        ...newDataItem
                    };

                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    
                    setTimeout(() => fetchHistory(true), 2000); 

                } catch (error) {
                    console.error('背景同步失敗，但本地已儲存', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteClick = (uuid) => {
                setDeleteTargetUuid(uuid);
                setShowDeleteModal(true);
            };

            const confirmDelete = async () => {
                const uuid = deleteTargetUuid;
                if (!uuid) return;
                
                setShowDeleteModal(false);
                
                const newData = historyData.filter(item => item.uuid !== uuid);
                setHistoryData(newData);
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(newData)); 
                showMessage('success', '紀錄已刪除');

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'delete', uuid: uuid })
                    });
                    setTimeout(() => fetchHistory(true), 2500);
                } catch (error) {
                    console.error(error);
                } finally {
                    setDeleteTargetUuid(null);
                }
            };

            const parseField = (str, options) => {
                if (!str) return { status: '', notes: '' };
                const match = str.match(/^\[(.*?)\]\s*(.*)/);
                if (match) {
                    return { status: match[1], notes: match[2] };
                }
                if (options.includes(str)) {
                    return { status: str, notes: '' };
                }
                return { status: '', notes: str };
            };

            const handleEditClick = (item) => {
                const bowel = parseField(item.bowel, OPTIONS.bowel);
                const diet = parseField(item.diet, OPTIONS.appetite);
                const behavior = parseField(item.behavior, OPTIONS.mood);

                setFormData({
                    bpSystolic: item.bpSystolic,
                    bpDiastolic: item.bpDiastolic,
                    bloodSugar: item.bloodSugar,
                    heartRate: item.heartRate || '',
                    medication: item.medication,
                    bowelStatus: bowel.status,
                    bowelNotes: bowel.notes,
                    appetite: diet.status,
                    dietContent: diet.notes,
                    mood: behavior.status,
                    behaviorNotes: behavior.notes
                });
                setEditingUuid(item.uuid);
                setIsEditing(true);
                setView('record');
            };

            const handleCancelEdit = () => {
                setIsEditing(false);
                setEditingUuid(null);
                setFormData(initialFormState);
                setView('history');
            };

            const fetchHistory = async (silent = false) => {
                if (!gasUrl) return;

                if (!silent) {
                    const cached = localStorage.getItem(STORAGE_KEY_HISTORY);
                    if (cached) {
                        try {
                            const parsedData = JSON.parse(cached);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                setHistoryData(parsedData);
                            }
                        } catch (e) { console.error(e); }
                    }
                    setLoading(true);
                }

                try {
                    const response = await fetch(gasUrl);
                    const result = await response.json();
                    const freshData = result.data || [];
                    
                    setHistoryData(freshData);
                    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(freshData));
                    
                } catch (error) {
                    console.error(error);
                    if (!silent) showMessage('error', '同步失敗，顯示本地資料');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (view === 'history') {
                    fetchHistory();
                }
            }, [view]);

            const formatDateTitle = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('/');
                if (parts.length >= 3) return `${parts[1]}/${parts[2]}`;
                const dashParts = dateStr.split('-');
                if (dashParts.length >= 3) return `${dashParts[1]}/${dashParts[2]}`;
                return dateStr;
            };

            const formatTime = (timeStr) => timeStr || '';

            const groupedHistory = useMemo(() => {
                const groups = [];
                historyData.forEach(item => {
                    const dateKey = item.date;
                    const existingGroup = groups.find(g => g.date === dateKey);
                    if (existingGroup) {
                        existingGroup.items.push(item);
                    } else {
                        groups.push({ date: dateKey, items: [item] });
                    }
                });
                return groups;
            }, [historyData]);

            const RenderField = ({ text, colorClass, icon }) => {
                if (!text) return null;
                const match = text.match(/^\[(.*?)\]\s*(.*)/);
                if (match) {
                    const status = match[1];
                    const content = match[2];
                    const isNormal = ['正常', '平穩', '佳'].includes(status);
                    
                    return (
                        <div className="flex flex-col">
                             <div className="flex items-center gap-2 mb-1">
                                {icon}
                                <span className={`badge-tag ${isNormal ? 'bg-gray-100 text-gray-500 border border-gray-200' : colorClass}`}>
                                    {status}
                                </span>
                            </div>
                            {content && <span className="text-brand-ink text-sm leading-relaxed pl-6">{content}</span>}
                        </div>
                    );
                }
                return (
                    <div className="flex items-start gap-2">
                        {icon}
                        <span className="text-brand-ink text-sm leading-relaxed">{text}</span>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative flex flex-col">
                    {/* Header - 7. 加入品牌名、引言、按鈕整合 */}
                    <header className="bg-brand-paper pt-8 pb-4 px-6 sticky top-0 z-40 border-b border-brand-sand/50 backdrop-blur-md bg-opacity-95">
                         <div className="flex justify-between items-end">
                            {/* Left Side: Brand & Title */}
                            <div className="flex flex-col">
                                <span className="text-xs font-bold tracking-[0.15em] text-brand-sage uppercase mb-1 block">常溫編集所 Ambient Edit Studio</span>
                                <h1 className="text-2xl font-bold text-brand-ink leading-tight">
                                    {isEditing ? '編輯紀錄' : '病人照護日誌'}
                                </h1>
                            </div>

                            {/* Right Side: Back Button (Bottom Aligned) - 2. 返回首頁按鈕 */}
                            <div className="flex items-center gap-3 mb-1">
                                {loading && (
                                    <div className="flex items-center text-xs text-brand-sage bg-white border border-brand-sand px-2 py-1 rounded-full animate-fade-in">
                                        <span className="spinner" style={{width:12, height:12, marginRight:4, borderTopColor:'#8da399', borderRightColor:'#f3f3f3'}}></span>
                                        同步中
                                    </div>
                                )}
                            </div>
                        </div>
                        {/* Quote/Intro */}
                        <div className="mt-2 text-xs text-gray-400 font-serif tracking-wide border-l-2 border-brand-clay pl-2">
                            記錄生活的起伏，是安頓身心的過程。
                        </div>
                    </header>

                    {/* Notification & Modals */}
                    {message && (
                        <div className={`p-3 m-4 rounded-lg text-sm font-bold text-center fixed top-24 left-0 right-0 z-50 shadow-soft mx-6 animate-fade-in border ${message.type === 'error' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-brand-sage/10 text-brand-sage border-brand-sage/20'}`}>
                            {message.text}
                        </div>
                    )}

                    {showDeleteModal && (
                        <div className="fixed inset-0 bg-brand-ink/20 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-brand-sand">
                                <div className="text-center mb-6">
                                    <h3 className="text-lg font-serif font-bold text-brand-ink mb-2">確定要刪除這筆紀錄？</h3>
                                    <p className="text-sm text-gray-500">刪除後將無法復原，請確認。</p>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => { setShowDeleteModal(false); setDeleteTargetUuid(null); }} className="flex-1 py-2 bg-brand-paper border border-brand-sand text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                        保留
                                    </button>
                                    <button onClick={confirmDelete} className="flex-1 py-2 bg-brand-clay text-white rounded-lg font-medium hover:bg-opacity-90 shadow-lg transition-colors">
                                        刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="p-6 flex-grow">
                        {view === 'settings' && (
                            <div className="card card-body animate-fade-in">
                                <h2 className="text-lg font-bold mb-4 text-brand-ink border-b border-brand-sand pb-2">資料庫連結</h2>
                                <p className="text-sm text-gray-500 mb-2">API Endpoint</p>
                                <input type="text" value={gasUrl} onChange={(e) => setGasUrl(e.target.value)} className="input-field mb-4 text-xs font-mono text-gray-400" />
                                <a href="https://docs.google.com/spreadsheets/d/1GFWKZ9A0-MRfh94rdh2BQ7EUO2ZKrS0P0bMc-HcimVg/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 px-4 mb-4 bg-brand-sage/10 border border-brand-sage/20 text-brand-sage rounded-lg font-bold hover:bg-brand-sage/20 transition-colors text-sm">
                                    <i data-lucide="database" className="w-4 h-4 mr-2"></i> 開啟 Google Sheet
                                </a>
                                <button onClick={handleNavToRecord} className="btn-primary mb-4">返回紀錄</button>
                            </div>
                        )}

                        {view === 'record' && (
                            <form onSubmit={handleSubmit} className="space-y-6 animate-fade-in">
                                {isEditing && (
                                    <div className="bg-brand-clay/10 text-brand-clay p-3 rounded-lg text-sm flex justify-between items-center border border-brand-clay/20">
                                        <span className="font-bold flex items-center gap-1"><i data-lucide="edit-3" className="w-4 h-4"></i> 編輯模式</span>
                                        <button type="button" onClick={handleCancelEdit} className="text-xs underline hover:text-brand-ink">取消</button>
                                    </div>
                                )}

                                {/* 生理數據 */}
                                <div className="card card-body">
                                    <h3 className="font-bold text-brand-sage mb-4 flex items-center gap-2 text-sm tracking-widest uppercase">
                                        <i data-lucide="activity" className="w-4 h-4"></i> 生理數值
                                    </h3>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="input-label">收縮壓 (高)</label>
                                            <input type="number" name="bpSystolic" value={formData.bpSystolic} onChange={handleChange} className="input-field font-mono" placeholder="120" />
                                        </div>
                                        <div>
                                            <label className="input-label">舒張壓 (低)</label>
                                            <input type="number" name="bpDiastolic" value={formData.bpDiastolic} onChange={handleChange} className="input-field font-mono" placeholder="80" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="input-label">血糖 (mg/dL)</label>
                                            <input type="number" name="bloodSugar" value={formData.bloodSugar} onChange={handleChange} className="input-field font-mono" placeholder="100" />
                                        </div>
                                        <div>
                                            <label className="input-label">心跳率 (bpm)</label>
                                            <input type="number" name="heartRate" value={formData.heartRate} onChange={handleChange} className="input-field font-mono" placeholder="75" />
                                        </div>
                                    </div>
                                </div>

                                {/* 護理紀錄 */}
                                <div className="card card-body space-y-5">
                                    <h3 className="font-bold text-brand-sage mb-2 flex items-center gap-2 text-sm tracking-widest uppercase">
                                        <i data-lucide="clipboard-list" className="w-4 h-4"></i> 護理觀察
                                    </h3>

                                    {/* 排便狀況 */}
                                    <div>
                                        <label className="input-label">排便狀況</label>
                                        <div className="flex gap-2">
                                            <select name="bowelStatus" value={formData.bowelStatus} onChange={handleChange} className="input-field w-1/3 bg-white/50">
                                                <option value="">選擇</option>
                                                {OPTIONS.bowel.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                            </select>
                                            <input type="text" name="bowelNotes" value={formData.bowelNotes} onChange={handleChange} className="input-field w-2/3" placeholder="備註 (顏色/量)..." />
                                        </div>
                                    </div>

                                    {/* 飲食內容 */}
                                    <div>
                                        <label className="input-label">飲食紀錄</label>
                                        <div className="flex gap-2 items-start">
                                            <div className="w-1/3">
                                                <span className="text-[10px] text-gray-400 mb-1 block">食慾</span>
                                                <select name="appetite" value={formData.appetite} onChange={handleChange} className="input-field bg-white/50">
                                                    <option value="">選擇</option>
                                                    {OPTIONS.appetite.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </div>
                                            <div className="w-2/3">
                                                <span className="text-[10px] text-gray-400 mb-1 block">內容/備註</span>
                                                <input type="text" name="dietContent" value={formData.dietContent} onChange={handleChange} className="input-field" placeholder="吃了什麼..." />
                                            </div>
                                        </div>
                                    </div>

                                    {/* 行為情緒 */}
                                    <div>
                                        <label className="input-label">行為/情緒</label>
                                        <div className="flex gap-2 items-start">
                                            <div className="w-1/3">
                                                <span className="text-[10px] text-gray-400 mb-1 block">情緒</span>
                                                <select name="mood" value={formData.mood} onChange={handleChange} className="input-field bg-white/50">
                                                    <option value="">選擇</option>
                                                    {OPTIONS.mood.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </div>
                                            <div className="w-2/3">
                                                <span className="text-[10px] text-gray-400 mb-1 block">觀察紀錄</span>
                                                <input type="text" name="behaviorNotes" value={formData.behaviorNotes} onChange={handleChange} className="input-field" placeholder="睡眠/行為表現..." />
                                            </div>
                                        </div>
                                    </div>

                                    {/* 服藥紀錄 */}
                                    <div className="pt-2 border-t border-brand-sand/50">
                                        <label className="input-label">服藥/飲食紀錄</label>
                                        <textarea name="medication" value={formData.medication} onChange={handleChange} rows="2" className="input-field resize-none" placeholder="藥名與時間..."></textarea>
                                    </div>
                                </div>

                                <div className="pt-4">
                                    <button type="submit" disabled={loading} className={`btn-primary ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                        {loading ? <span><span className="spinner-white"></span> 處理中...</span> : (isEditing ? '更新紀錄' : '確認記錄')}
                                    </button>
                                    {isEditing && (
                                        <button type="button" onClick={handleCancelEdit} className="btn-secondary w-full mt-3">放棄編輯</button>
                                    )}
                                </div>
                            </form>
                        )}

                        {view === 'history' && (
                            <div className="space-y-8 animate-fade-in">
                                {!loading && groupedHistory.length === 0 && (
                                    <div className="text-center py-10 opacity-50">
                                        <i data-lucide="book-open" className="w-12 h-12 mx-auto text-brand-sand mb-2"></i>
                                        <p className="text-brand-ink font-serif">尚未開始紀錄</p>
                                    </div>
                                )}

                                {groupedHistory.map((group, groupIndex) => (
                                    <div key={groupIndex} className="relative pl-4 border-l border-brand-sand/60">
                                        <div className="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-brand-sage border-2 border-brand-paper"></div>
                                        
                                        <div className="flex items-baseline gap-2 mb-4 pl-2">
                                            <h3 className="text-xl font-serif font-bold text-brand-ink">{formatDateTitle(group.date)}</h3>
                                            <span className="text-xs text-gray-400 font-mono">{group.items.length} 筆</span>
                                        </div>

                                        <div className="space-y-4">
                                            {group.items.map((item, itemIndex) => (
                                                <div key={item.uuid || itemIndex} className="card relative group hover:border-brand-sage/30 transition-colors">
                                                    <div className="p-4">
                                                        {/* Header: Time & Vitals */}
                                                        <div className="flex justify-between items-start mb-3 pb-3 border-b border-dashed border-brand-sand/50">
                                                            <span className="text-sm font-bold text-brand-sage font-mono bg-brand-sage/10 px-2 py-0.5 rounded">
                                                                {formatTime(item.time)}
                                                            </span>
                                                            <div className="flex gap-1.5 flex-wrap justify-end">
                                                                {(item.bpSystolic || item.bpDiastolic) && (
                                                                    <span className="badge-bp">血壓 {item.bpSystolic}/{item.bpDiastolic}</span>
                                                                )}
                                                                {item.heartRate && (
                                                                    <span className="badge-hr">心跳 {item.heartRate}</span>
                                                                )}
                                                                {item.bloodSugar && (
                                                                    <span className="badge-sugar">血糖 {item.bloodSugar}</span>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* Content Body */}
                                                        <div className="space-y-3">
                                                            <RenderField 
                                                                text={item.bowel} 
                                                                colorClass="bg-purple-50 text-purple-600 border border-purple-100" 
                                                                icon={<i data-lucide="check-circle-2" className="w-3.5 h-3.5 text-gray-400 mt-0.5"></i>}
                                                            />
                                                            <RenderField 
                                                                text={item.diet} 
                                                                colorClass="bg-orange-50 text-orange-600 border border-orange-100" 
                                                                icon={<i data-lucide="utensils" className="w-3.5 h-3.5 text-gray-400 mt-0.5"></i>}
                                                            />
                                                            <RenderField 
                                                                text={item.behavior} 
                                                                colorClass="bg-blue-50 text-blue-600 border border-blue-100" 
                                                                icon={<i data-lucide="brain-circuit" className="w-3.5 h-3.5 text-gray-400 mt-0.5"></i>}
                                                            />
                                                            {item.medication && (
                                                                <div className="flex items-start gap-2 bg-brand-paper p-2 rounded text-xs text-gray-600 border border-brand-sand/50">
                                                                    <i data-lucide="pill" className="w-3.5 h-3.5 text-brand-sage mt-0.5"></i>
                                                                    <span>{item.medication}</span>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* Actions */}
                                                        <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                                            <button onClick={() => handleEditClick(item)} className="p-1.5 bg-white border border-brand-sand text-brand-sage rounded-full hover:bg-brand-sage hover:text-white transition-colors">
                                                                <i data-lucide="edit-2" className="w-3 h-3"></i>
                                                            </button>
                                                            <button onClick={() => handleDeleteClick(item.uuid)} className="p-1.5 bg-white border border-brand-sand text-brand-clay rounded-full hover:bg-brand-clay hover:text-white transition-colors">
                                                                <i data-lucide="trash-2" className="w-3 h-3"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Footer - 3. 版權設定 */}
                    <footer className="text-center py-6 text-[10px] text-gray-400 font-serif tracking-widest border-t border-brand-sand/50 mx-6">
                        <p>© 2026 常溫編集所 Ambient Edit Studio.</p>
                    </footer>

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-brand-sand flex justify-around p-2 pb-5 shadow-[0_-4px_20px_-2px_rgba(0,0,0,0.03)] z-50 max-w-md mx-auto">
                        <div onClick={handleNavToRecord} className={`nav-item flex flex-col items-center flex-1 ${view === 'record' ? 'active' : ''}`}>
                            <i data-lucide="pen-line" className={`w-5 h-5 mb-1 ${view === 'record' ? 'text-brand-sage' : 'text-gray-300'}`}></i>
                            <span className="text-[10px] tracking-widest">紀錄</span>
                        </div>
                        <div onClick={() => setView('settings')} className="flex items-center justify-center -mt-8">
                            <div className="w-12 h-12 bg-brand-sage rounded-full shadow-lg flex items-center justify-center text-white cursor-pointer hover:bg-brand-sage/90 transition-colors border-4 border-brand-paper">
                                <i data-lucide="settings-2" className="w-5 h-5"></i>
                            </div>
                        </div>
                        <div onClick={() => setView('history')} className={`nav-item flex flex-col items-center flex-1 ${view === 'history' ? 'active' : ''}`}>
                            <i data-lucide="history" className={`w-5 h-5 mb-1 ${view === 'history' ? 'text-brand-sage' : 'text-gray-300'}`}></i>
                            <span className="text-[10px] tracking-widest">歷史</span>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
