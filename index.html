<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>病人照護日誌</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Segoe UI', Microsoft JhengHei, sans-serif; background-color: #f0fdfa; }
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .input-field { width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid #d1d5db; outline: none; transition: border-color 0.2s; font-size: 0.95rem; }
        .input-field:focus { border-color: #14b8a6; ring: 2px solid #99f6e4; }
        .btn-primary { background-color: #0d9488; color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; font-weight: bold; transition: background 0.2s; }
        .btn-primary:hover { background-color: #0f766e; }
        .btn-secondary { background-color: #fff; border: 1px solid #d1d5db; color: #374151; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 0; margin-bottom: 1.5rem; overflow: hidden; }
        .card-header { padding: 1rem 1.5rem; background-color: #f0fdfa; border-bottom: 1px solid #ccfbf1; }
        .card-body { padding: 1.5rem; }
        .nav-item { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 600; }
        .nav-item.active { background-color: #ccfbf1; color: #0f766e; }
        
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .spinner-white { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 4px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .badge-sugar { background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }
        .badge-bp { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #93c5fd; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }
        .badge-hr { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }
        .badge-tag { display: inline-block; padding: 1px 6px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-right: 6px; border: 1px solid transparent; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzuba69RCVJhp_hYzgQB9X7jLMThFkIotjbtzfpqSH_mmest0flzX8sdf-Q5h5JtvYg/exec";
        const STORAGE_KEY_HISTORY = 'patient_tracker_history_v1';

        const OPTIONS = {
            bowel: ['正常', '便秘', '腹瀉', '失禁', '其他'],
            appetite: ['正常', '佳', '差', '其他'],
            mood: ['平穩', '開心', '焦慮', '生氣', '憂鬱', '躁動', '其他']
        };

        const App = () => {
            const [view, setView] = useState('record'); 
            const [gasUrl, setGasUrl] = useState(localStorage.getItem('patient_tracker_url') || DEFAULT_API_URL);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            
            const [isEditing, setIsEditing] = useState(false);
            const [editingUuid, setEditingUuid] = useState(null);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTargetUuid, setDeleteTargetUuid] = useState(null);

            const initialFormState = {
                bpSystolic: '', bpDiastolic: '', bloodSugar: '', heartRate: '',
                medication: '', bowelStatus: '', bowelNotes: '',
                appetite: '', dietContent: '', mood: '', behaviorNotes: ''
            };
            const [formData, setFormData] = useState(initialFormState);

            useEffect(() => {
                if (!localStorage.getItem('patient_tracker_url')) {
                    localStorage.setItem('patient_tracker_url', DEFAULT_API_URL);
                    setGasUrl(DEFAULT_API_URL);
                }
                lucide.createIcons();
            }, [view, historyData, showDeleteModal]);

            const showMessage = (type, text) => {
                setMessage({ type, text });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleSaveUrl = (url) => {
                const cleanUrl = url.trim();
                localStorage.setItem('patient_tracker_url', cleanUrl);
                setGasUrl(cleanUrl);
                showMessage('success', 'API 網址已儲存！');
            };

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleNavToRecord = () => {
                if (view !== 'record' || isEditing) {
                    setIsEditing(false);
                    setEditingUuid(null);
                    setFormData(initialFormState); 
                    setView('record');
                }
            };

            // 核心修改：即時寫入本地，防止資料被吃掉
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!gasUrl) {
                    showMessage('error', 'API URL 未設定');
                    setView('settings');
                    return;
                }

                setLoading(true);
                
                // 1. 準備資料
                const action = isEditing ? 'update' : 'create';
                // 如果是新增，產生一個臨時 ID (與後端同步邏輯一致)
                const currentUuid = isEditing ? editingUuid : crypto.randomUUID(); 
                
                const now = new Date();
                const todayStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

                const formatPayloadField = (status, content) => {
                    const statusPart = status ? `[${status}]` : '';
                    return `${statusPart} ${content || ''}`.trim();
                };

                const newDataItem = {
                    uuid: currentUuid,
                    date: todayStr, // 即時顯示用
                    time: timeStr,
                    bpSystolic: formData.bpSystolic,
                    bpDiastolic: formData.bpDiastolic,
                    bloodSugar: formData.bloodSugar,
                    heartRate: formData.heartRate,
                    medication: formData.medication,
                    bowel: formatPayloadField(formData.bowelStatus, formData.bowelNotes),
                    diet: formatPayloadField(formData.appetite, formData.dietContent),
                    behavior: formatPayloadField(formData.mood, formData.behaviorNotes)
                };

                // 2. 超級即時更新：不管後端，先更新本地畫面
                let updatedHistory;
                if (isEditing) {
                    updatedHistory = historyData.map(item => item.uuid === currentUuid ? { ...item, ...newDataItem } : item);
                } else {
                    updatedHistory = [newDataItem, ...historyData];
                }
                
                setHistoryData(updatedHistory);
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(updatedHistory));
                
                showMessage('success', isEditing ? '修改成功！' : '紀錄已送出！');
                
                // 3. 重置表單並跳轉 (讓使用者感覺非常快)
                setFormData(initialFormState);
                setIsEditing(false);
                setEditingUuid(null);
                if (isEditing) {
                    setView('history');
                }

                // 4. 背景發送請求給 GAS
                try {
                    const payload = {
                        action: action,
                        uuid: currentUuid, // 確保 GAS 使用相同的 UUID
                        ...newDataItem
                    };

                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    
                    // 5. 延遲後再次同步確保一致性，但不顯示 loading 避免閃爍
                    setTimeout(() => fetchHistory(true), 2000); 

                } catch (error) {
                    console.error('背景同步失敗，但本地已儲存', error);
                    // 這裡不報錯，因為本地已經有資料了
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteClick = (uuid) => {
                setDeleteTargetUuid(uuid);
                setShowDeleteModal(true);
            };

            const confirmDelete = async () => {
                const uuid = deleteTargetUuid;
                if (!uuid) return;
                
                setShowDeleteModal(false);
                
                const newData = historyData.filter(item => item.uuid !== uuid);
                setHistoryData(newData);
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(newData)); 
                showMessage('success', '紀錄已刪除');

                try {
                    await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'delete', uuid: uuid })
                    });
                    setTimeout(() => fetchHistory(true), 2500);
                } catch (error) {
                    console.error(error);
                } finally {
                    setDeleteTargetUuid(null);
                }
            };

            const parseField = (str, options) => {
                if (!str) return { status: '', notes: '' };
                const match = str.match(/^\[(.*?)\]\s*(.*)/);
                if (match) {
                    return { status: match[1], notes: match[2] };
                }
                if (options.includes(str)) {
                    return { status: str, notes: '' };
                }
                return { status: '', notes: str };
            };

            const handleEditClick = (item) => {
                const bowel = parseField(item.bowel, OPTIONS.bowel);
                const diet = parseField(item.diet, OPTIONS.appetite);
                const behavior = parseField(item.behavior, OPTIONS.mood);

                setFormData({
                    bpSystolic: item.bpSystolic,
                    bpDiastolic: item.bpDiastolic,
                    bloodSugar: item.bloodSugar,
                    heartRate: item.heartRate || '',
                    medication: item.medication,
                    bowelStatus: bowel.status,
                    bowelNotes: bowel.notes,
                    appetite: diet.status,
                    dietContent: diet.notes,
                    mood: behavior.status,
                    behaviorNotes: behavior.notes
                });
                setEditingUuid(item.uuid);
                setIsEditing(true);
                setView('record');
            };

            const handleCancelEdit = () => {
                setIsEditing(false);
                setEditingUuid(null);
                setFormData(initialFormState);
                setView('history');
            };

            // silent 參數控制是否顯示 Loading 條 (用於背景同步)
            const fetchHistory = async (silent = false) => {
                if (!gasUrl) return;

                if (!silent) {
                    const cached = localStorage.getItem(STORAGE_KEY_HISTORY);
                    if (cached) {
                        try {
                            const parsedData = JSON.parse(cached);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                setHistoryData(parsedData);
                            }
                        } catch (e) { console.error(e); }
                    }
                    setLoading(true);
                }

                try {
                    const response = await fetch(gasUrl);
                    const result = await response.json();
                    const freshData = result.data || [];
                    
                    setHistoryData(freshData);
                    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(freshData));
                    
                } catch (error) {
                    console.error(error);
                    if (!silent) showMessage('error', '同步失敗，顯示本地資料');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (view === 'history') {
                    fetchHistory();
                }
            }, [view]);

            const formatDateTitle = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('/');
                if (parts.length >= 3) return `${parts[1]}/${parts[2]}`;
                const dashParts = dateStr.split('-');
                if (dashParts.length >= 3) return `${dashParts[1]}/${dashParts[2]}`;
                return dateStr;
            };

            const formatTime = (timeStr) => timeStr || '';

            const groupedHistory = useMemo(() => {
                const groups = [];
                historyData.forEach(item => {
                    const dateKey = item.date;
                    const existingGroup = groups.find(g => g.date === dateKey);
                    if (existingGroup) {
                        existingGroup.items.push(item);
                    } else {
                        groups.push({ date: dateKey, items: [item] });
                    }
                });
                return groups;
            }, [historyData]);

            const RenderField = ({ text, colorClass }) => {
                if (!text) return null;
                const match = text.match(/^\[(.*?)\]\s*(.*)/);
                if (match) {
                    const status = match[1];
                    const content = match[2];
                    const isNormal = ['正常', '平穩', '佳'].includes(status);
                    
                    return (
                        <div>
                            <span className={`badge-tag ${isNormal ? 'bg-gray-100 text-gray-600' : colorClass}`}>
                                {status}
                            </span>
                            <span className="text-gray-800 font-medium break-words">{content}</span>
                        </div>
                    );
                }
                return <span className="font-medium text-gray-800 break-words">{text}</span>;
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    {/* Header */}
                    <header className="bg-teal-600 text-white p-4 shadow-lg sticky top-0 z-40">
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <i data-lucide="activity" className="w-6 h-6"></i>
                                {isEditing ? '編輯紀錄' : '病人照護日誌'}
                            </h1>
                            <div className="flex items-center gap-2">
                                {loading && (
                                    <div className="flex items-center text-xs text-teal-100 bg-teal-700 bg-opacity-50 px-3 py-1 rounded-full animate-fade-in transition-all">
                                        <span className="spinner-white"></span>
                                        同步中...
                                    </div>
                                )}
                                <button onClick={() => setView('settings')} className="p-2 hover:bg-teal-700 rounded-full">
                                    <i data-lucide="settings" className="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Notification & Modals */}
                    {message && (
                        <div className={`p-3 m-4 rounded-lg text-sm font-bold text-center fixed top-16 left-0 right-0 z-50 shadow-lg mx-4 animate-fade-in ${message.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                            {message.text}
                        </div>
                    )}

                    {showDeleteModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                <div className="text-center mb-4">
                                    <div className="bg-red-100 p-3 rounded-full inline-block mb-3">
                                        <i data-lucide="alert-triangle" className="w-8 h-8 text-red-500"></i>
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-800">確定要刪除嗎？</h3>
                                    <p className="text-sm text-gray-500 mt-1">此動作無法復原，該筆紀錄將被永久移除。</p>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => { setShowDeleteModal(false); setDeleteTargetUuid(null); }}
                                        className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={confirmDelete}
                                        className="flex-1 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 shadow-lg transition-colors"
                                    >
                                        刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="p-4">
                        {view === 'settings' && (
                            <div className="card card-body animate-fade-in">
                                <h2 className="text-lg font-bold mb-4 text-gray-800">系統設定</h2>
                                <p className="text-sm text-gray-500 mb-2">資料庫 API (已內建)</p>
                                <input type="text" value={gasUrl} onChange={(e) => setGasUrl(e.target.value)} className="input-field mb-4 text-sm bg-gray-50 text-gray-500" readOnly />
                                <a href="https://docs.google.com/spreadsheets/d/1GFWKZ9A0-MRfh94rdh2BQ7EUO2ZKrS0P0bMc-HcimVg/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full py-3 px-4 mb-4 bg-teal-50 border border-teal-200 text-teal-700 rounded-lg font-bold hover:bg-teal-100 transition-colors">
                                    <i data-lucide="database" className="w-5 h-5 mr-2"></i> 查看資料庫 (Google Sheet)
                                </a>
                                <button onClick={handleNavToRecord} className="btn-primary mb-4">回到紀錄頁面</button>
                            </div>
                        )}

                        {view === 'record' && (
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {isEditing && (
                                    <div className="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm mb-4 flex justify-between items-center border border-yellow-200">
                                        <span className="font-bold flex items-center gap-1"><i data-lucide="alert-circle" className="w-4 h-4"></i> 編輯模式</span>
                                        <button type="button" onClick={handleCancelEdit} className="text-gray-500 underline hover:text-gray-800">取消</button>
                                    </div>
                                )}

                                {/* 生理數據 */}
                                <div className="card card-body">
                                    <h3 className="font-bold text-teal-700 mb-3 border-b pb-2 flex items-center gap-2">
                                        <i data-lucide="heart-pulse" className="w-4 h-4"></i> 生理數值
                                    </h3>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label className="input-label">收縮壓 (高)</label>
                                            <input type="number" name="bpSystolic" value={formData.bpSystolic} onChange={handleChange} className="input-field" placeholder="120" />
                                        </div>
                                        <div>
                                            <label className="input-label">舒張壓 (低)</label>
                                            <input type="number" name="bpDiastolic" value={formData.bpDiastolic} onChange={handleChange} className="input-field" placeholder="80" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="input-label">血糖 (mg/dL)</label>
                                            <input type="number" name="bloodSugar" value={formData.bloodSugar} onChange={handleChange} className="input-field" placeholder="100" />
                                        </div>
                                        <div>
                                            <label className="input-label">心跳率 (bpm)</label>
                                            <input type="number" name="heartRate" value={formData.heartRate} onChange={handleChange} className="input-field" placeholder="75" />
                                        </div>
                                    </div>
                                </div>

                                {/* 護理紀錄 */}
                                <div className="card card-body space-y-4">
                                    <h3 className="font-bold text-teal-700 mb-3 border-b pb-2 flex items-center gap-2">
                                        <i data-lucide="clipboard-list" className="w-4 h-4"></i> 護理紀錄
                                    </h3>

                                    {/* 排便狀況 */}
                                    <div>
                                        <label className="input-label">排便狀況</label>
                                        <div className="flex gap-2">
                                            <select name="bowelStatus" value={formData.bowelStatus} onChange={handleChange} className="input-field w-1/3 bg-white">
                                                <option value="">請選擇</option>
                                                {OPTIONS.bowel.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                            </select>
                                            <input type="text" name="bowelNotes" value={formData.bowelNotes} onChange={handleChange} className="input-field w-2/3" placeholder="備註 (顏色/量)..." />
                                        </div>
                                    </div>

                                    {/* 飲食內容 */}
                                    <div>
                                        <label className="input-label">飲食紀錄</label>
                                        <div className="flex gap-2 items-start">
                                            <div className="w-1/3">
                                                <span className="text-xs text-gray-500 mb-1 block">食慾</span>
                                                <select name="appetite" value={formData.appetite} onChange={handleChange} className="input-field bg-white">
                                                    <option value="">請選擇</option>
                                                    {OPTIONS.appetite.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </div>
                                            <div className="w-2/3">
                                                <span className="text-xs text-gray-500 mb-1 block">內容/備註</span>
                                                <input type="text" name="dietContent" value={formData.dietContent} onChange={handleChange} className="input-field" placeholder="吃了什麼..." />
                                            </div>
                                        </div>
                                    </div>

                                    {/* 行為情緒 */}
                                    <div>
                                        <label className="input-label">行為/情緒</label>
                                        <div className="flex gap-2 items-start">
                                            <div className="w-1/3">
                                                <span className="text-xs text-gray-500 mb-1 block">情緒</span>
                                                <select name="mood" value={formData.mood} onChange={handleChange} className="input-field bg-white">
                                                    <option value="">請選擇</option>
                                                    {OPTIONS.mood.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </div>
                                            <div className="w-2/3">
                                                <span className="text-xs text-gray-500 mb-1 block">觀察紀錄</span>
                                                <input type="text" name="behaviorNotes" value={formData.behaviorNotes} onChange={handleChange} className="input-field" placeholder="睡眠狀況/行為..." />
                                            </div>
                                        </div>
                                    </div>

                                    {/* 服藥紀錄 */}
                                    <div className="input-group pt-2 border-t border-gray-100">
                                        <label className="input-label">服藥紀錄</label>
                                        <textarea name="medication" value={formData.medication} onChange={handleChange} rows="2" className="input-field" placeholder="藥名與時間..."></textarea>
                                    </div>
                                </div>

                                <button type="submit" disabled={loading} className={`btn-primary shadow-lg ${loading ? 'opacity-70' : ''}`}>
                                    {loading ? <span><span className="spinner"></span>處理中...</span> : (isEditing ? '更新紀錄' : '提交紀錄')}
                                </button>
                                {isEditing && (
                                    <button type="button" onClick={handleCancelEdit} className="btn-secondary w-full mt-2">取消編輯</button>
                                )}
                            </form>
                        )}

                        {view === 'history' && (
                            <div className="space-y-6">
                                {!loading && groupedHistory.length === 0 && <div className="text-center text-gray-500 mt-10">尚無紀錄</div>}

                                {groupedHistory.map((group, groupIndex) => (
                                    <div key={groupIndex} className="card border-l-4 border-teal-500 animate-fade-in">
                                        <div className="card-header flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <i data-lucide="calendar" className="w-5 h-5 text-teal-600"></i>
                                                <span className="text-xl font-bold text-gray-800 tracking-wide">{formatDateTitle(group.date)}</span>
                                            </div>
                                            <span className="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full font-medium">{group.items.length} 筆資料</span>
                                        </div>

                                        <div className="card-body bg-white space-y-6">
                                            {group.items.map((item, itemIndex) => (
                                                <div key={item.uuid || itemIndex} className={`relative ${itemIndex !== group.items.length - 1 ? 'border-b border-gray-100 pb-6' : ''}`}>
                                                    
                                                    {/* 數值區 */}
                                                    <div className="flex flex-wrap justify-between items-start mb-3 gap-2">
                                                        <span className="text-sm font-bold text-teal-700 bg-teal-50 px-2 py-1 rounded flex items-center gap-1">
                                                            <i data-lucide="clock" className="w-3 h-3"></i> {formatTime(item.time)}
                                                        </span>
                                                        <div className="flex flex-wrap gap-2 justify-end">
                                                            {(item.bpSystolic || item.bpDiastolic) && (
                                                                <span className="badge-bp flex items-center gap-1"><i data-lucide="heart-pulse" className="w-3 h-3"></i> 血壓: {item.bpSystolic}/{item.bpDiastolic}</span>
                                                            )}
                                                            {item.heartRate && (
                                                                <span className="badge-hr flex items-center gap-1"><i data-lucide="activity" className="w-3 h-3"></i> 心跳: {item.heartRate}</span>
                                                            )}
                                                            {item.bloodSugar && (
                                                                <span className="badge-sugar flex items-center gap-1"><i data-lucide="droplet" className="w-3 h-3"></i> 血糖: {item.bloodSugar}</span>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* 內容區 */}
                                                    <div className="space-y-2 text-sm text-gray-700 pl-1">
                                                        
                                                        {item.bowel && (
                                                             <div className="flex flex-col bg-purple-50 p-2 rounded border border-purple-100">
                                                                <span className="text-xs font-bold text-purple-600 mb-1 flex items-center gap-1 uppercase"><i data-lucide="check-circle-2" className="w-3 h-3"></i> 排便狀況</span>
                                                                <RenderField text={item.bowel} colorClass="bg-purple-200 text-purple-800" />
                                                            </div>
                                                        )}

                                                        {item.diet && (
                                                            <div className="flex flex-col bg-orange-50 p-2 rounded border border-orange-100">
                                                                <span className="text-xs font-bold text-orange-500 mb-1 flex items-center gap-1 uppercase"><i data-lucide="utensils" className="w-3 h-3"></i> 飲食紀錄</span>
                                                                <RenderField text={item.diet} colorClass="bg-orange-200 text-orange-800" />
                                                            </div>
                                                        )}
                                                        
                                                        {item.behavior && (
                                                            <div className="flex flex-col bg-blue-50 p-2 rounded border border-blue-100">
                                                                <span className="text-xs font-bold text-blue-600 mb-1 flex items-center gap-1 uppercase"><i data-lucide="brain-circuit" className="w-3 h-3"></i> 行為/情緒</span>
                                                                <RenderField text={item.behavior} colorClass="bg-blue-200 text-blue-800" />
                                                            </div>
                                                        )}

                                                        {item.medication && (
                                                            <div className="flex flex-col bg-slate-50 p-2 rounded border border-slate-100">
                                                                <span className="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1 uppercase"><i data-lucide="pill" className="w-3 h-3"></i> 服藥紀錄</span>
                                                                <span className="font-medium text-gray-800 break-words">{item.medication}</span>
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div className="mt-3 flex justify-end gap-2">
                                                        {item.uuid && (
                                                            <>
                                                                <button onClick={() => handleEditClick(item)} className="px-2 py-1 text-xs bg-white border border-teal-500 text-teal-600 rounded hover:bg-teal-50 flex items-center gap-1 transition-colors"><i data-lucide="edit-2" className="w-3 h-3"></i> 編輯</button>
                                                                <button onClick={() => handleDeleteClick(item.uuid)} className="px-2 py-1 text-xs bg-white border border-red-300 text-red-500 rounded hover:bg-red-50 flex items-center gap-1 transition-colors"><i data-lucide="trash-2" className="w-3 h-3"></i> 刪除</button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-4 shadow-lg z-30 max-w-md mx-auto">
                        <div onClick={handleNavToRecord} className={`nav-item flex flex-col items-center ${view === 'record' ? 'active' : 'text-gray-500'}`}>
                            <i data-lucide="plus-circle" className="w-6 h-6 mb-1"></i>
                            <span className="text-xs">新增紀錄</span>
                        </div>
                        <div onClick={() => setView('history')} className={`nav-item flex flex-col items-center ${view === 'history' ? 'active' : 'text-gray-500'}`}>
                            <i data-lucide="history" className="w-6 h-6 mb-1"></i>
                            <span className="text-xs">歷史紀錄</span>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
